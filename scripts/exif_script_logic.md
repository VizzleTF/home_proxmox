# Логика скрипта fix_exif_dates_new.sh

## Обзор
Скрипт обрабатывает фото и видео файлы в указанной папке года, устанавливая EXIF/метаданные дат на основе приоритетной логики извлечения дат.

## Архитектура скрипта

```mermaid
flowchart TD
    A[Запуск скрипта с аргументом YEAR] --> B[Переход в директорию BASE_DIR/YEAR]
    B --> C[Поиск всех поддерживаемых файлов рекурсивно]
    
    C --> D["find . -type f (jpg|jpeg|png|webp|mov|mp4)"]
    D --> E[Для каждого файла: process_single_file]
    
    E --> F1["1. Проверка и исправление расширения файла"]
    F1 --> G1["file -b для определения реального типа"]
    G1 --> H1{Расширение соответствует типу?}
    H1 -->|Нет| I1["Переименование файла (PNG→JPEG и т.д.)"]
    H1 -->|Да| J1[Продолжить обработку]
    I1 --> J1
    
    J1 --> F2["2. Проверка существующих метаданных"]
    F2 --> G2{Есть EXIF/видео метаданные?}
    G2 -->|Да| H2[Пропустить файл]
    G2 -->|Нет| J2[Извлечение даты по приоритетам]
    
    J2 --> F3["3. ПРИОРИТЕТ 1: Дата из имени файла"]
    F3 --> G3["Проверка паттернов имени файла"]
    G3 --> P1["IMG_YYYYMMDD_HHMMSS"]
    G3 --> P2["YYYY-MM-DD или YYYY_MM_DD"]
    G3 --> P3["YY-MM-DD HH-MM-SS"]
    G3 --> P4["P_YYYYMMDD_HHMMSS"]
    G3 --> P5["YYYYMMDD_HHMMSS_lmc"]
    G3 --> P6["YYYYMMDD (8 цифр)"]
    G3 --> P7["Unix timestamp"]
    
    P1 --> K1{Найден паттерн?}
    P2 --> K1
    P3 --> K1
    P4 --> K1
    P5 --> K1
    P6 --> K1
    P7 --> K1
    
    K1 -->|Да| L1[Применить дату из имени]
    K1 -->|Нет| F4["4. ПРИОРИТЕТ 2: Дата из папки месяца"]
    
    F4 --> G4{"Файл в папке ./MM/?"}
    G4 -->|Да| H4["Использовать YEAR:MM:01 12:00:00"]
    G4 -->|Нет| F5["5. ПРИОРИТЕТ 3: Дата из папки года"]
    
    F5 --> H5["Использовать YEAR:06:01 12:00:00"]
    
    L1 --> M[Применение метаданных через exiftool]
    H4 --> M
    H5 --> M
    
    M --> N1{Тип файла?}
    N1 -->|Изображение| O1["DateTimeOriginal, CreateDate, ModifyDate"]
    N1 -->|Видео| O2["CreateDate, ModifyDate, MediaCreateDate, TrackCreateDate"]
    
    O1 --> Q[Статистика и завершение]
    O2 --> Q
    H2 --> Q
    
    style F1 fill:#e6f3ff
    style F2 fill:#e6f3ff
    style F3 fill:#ccffcc
    style F4 fill:#ffeecc
    style F5 fill:#ffcccc
    style M fill:#ccffcc
```

## Детальная логика обработки

### 1. Проверка и исправление расширений файлов
- Использует команду `file -b` для определения реального типа файла
- Автоматически переименовывает файлы с неправильными расширениями:
  - PNG файл с содержимым JPEG → переименование в .jpg
  - Аналогично для других несоответствий
- Поддерживаемые типы:
  - **Изображения**: JPEG, PNG, WebP, TIFF, GIF
  - **Видео**: MP4, QuickTime/MOV

### 2. Проверка существующих метаданных
- **Для изображений**: проверяет наличие `DateTimeOriginal`
- **Для видео**: проверяет `CreateDate`, `MediaCreateDate`, `TrackCreateDate`
- Если метаданные уже есть → файл пропускается

### 3. Приоритетная система извлечения дат

#### ПРИОРИТЕТ 1: Паттерны в имени файла (от высшего к низшему)
1. **IMG_YYYYMMDD_HHMMSS** → `IMG_20241225_143022.jpg`
2. **YYYY-MM-DD или YYYY_MM_DD** → `2024-12-25_photo.jpg`
3. **YY-MM-DD HH-MM-SS** → `24-12-25 14-30-22.jpg`
4. **P_YYYYMMDD_HHMMSS** → `P_20241225_143022.jpg`
5. **YYYYMMDD_HHMMSS_lmc** → `20241225_143022_lmc.jpg`
6. **YYYYMMDD (8 цифр)** → `20241225.jpg`
7. **Unix timestamp** → `1703512800.jpg`

#### ПРИОРИТЕТ 2: Папка месяца
- Если файл находится в папке `./MM/` (например, `./12/`)
- Устанавливает дату: `YEAR:MM:01 12:00:00`
- Пример: файл в `./12/` получает дату `2024:12:01 12:00:00`

#### ПРИОРИТЕТ 3: Папка года (fallback)
- Если не найдено других источников даты
- Устанавливает дату: `YEAR:06:01 12:00:00`
- Пример: `2024:06:01 12:00:00`

### 4. Применение метаданных

#### Для изображений:
```bash
exiftool -overwrite_original \
  "-DateTimeOriginal=$date_str" \
  "-CreateDate=$date_str" \
  "-ModifyDate=$date_str" \
  "$file"
```

#### Для видео:
```bash
exiftool -overwrite_original \
  "-CreateDate=$date_str" \
  "-ModifyDate=$date_str" \
  "-MediaCreateDate=$date_str" \
  "-TrackCreateDate=$date_str" \
  "$file"
```

## Ключевые особенности

### Валидация данных
- Проверка корректности извлеченных дат
- Валидация компонентов даты (месяц 1-12, день 1-31, час 0-23, и т.д.)
- Проверка года в разумных пределах (1900-2100)

### Обработка ошибок
- Graceful handling неподдерживаемых типов файлов
- Логирование ошибок переименования и применения метаданных
- Подсчет статистики: успешные, неудачные, пропущенные файлы

### Режим dry-run
- Поддержка флага `--dry-run` для тестирования без изменений
- Показывает, какие операции будут выполнены

### Рекурсивная обработка
- Обрабатывает все файлы в указанной папке года и всех подпапках
- Использует `find` с фильтрацией по расширениям файлов

## Использование

```bash
# Обычный режим
./fix_exif_dates_new.sh 2024

# Режим тестирования
./fix_exif_dates_new.sh 2024 --dry-run
```

## Статистика выполнения
Скрипт выводит подробную статистику:
- Общее количество обработанных файлов
- Успешно обновленные файлы
- Файлы с ошибками обработки
- Пропущенные файлы (уже имеют метаданные)

## Команды для верификации
```bash
# Проверка EXIF дат изображений
exiftool -r -DateTimeOriginal -s -s -s . | head -20

# Проверка дат создания
exiftool -r -CreateDate -s -s -s . | head -20
```